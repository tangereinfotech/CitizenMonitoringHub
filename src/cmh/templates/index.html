{# Copyright 2011, Tangere Infotech Pvt Ltd [http://tangere.in]                 #}
{#                                                                              #}
{# Licensed under the Apache License, Version 2.0 (the "License");              #}
{# you may not use this file except in compliance with the License.             #}
{# You may obtain a copy of the License at                                      #}
{#                                                                              #}
{#       http://www.apache.org/licenses/LICENSE-2.0                             #}
{#                                                                              #}
{# Unless required by applicable law or agreed to in writing, software          #}
{# distributed under the License is distributed on an "AS IS" BASIS,            #}
{# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.     #}
{# See the License for the specific language governing permissions and          #}
{# limitations under the License.                                               #}

{% extends "signinbase.html" %}

{% load i18n %}

{% block extra_heads %}
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false" ></script>
<meta name="viewport" content="initial-scale=0.1, user-scalable=no" />
<meta http-equiv="expires" content="0">
{% endblock %}
{% block page_content %}
<div id="department-list">
  <fieldset>
    <legend>
      {% trans "Time Period" %}
    </legend>
    <table align="center" style="width-100">
      <tr>
        <td style="text-align:center">
          {% trans "Start Date" %}
        </td>
        <td style="text-align:center">
          {% trans "End Date" %}
        </td>
        <td/>
      </tr>
      <tr>
        <td style="text-align:right">
          {{ form.stdate }}
        </td>
        <td style="text-align:left">
          {{ form.endate }}
        </td>
        <td>
          <button type="button" width="120px" class="btn" onclick="update_maps ();">{% trans "Apply" %}</button>
        </td>
      </tr>
      <tr>
        <td colspan="3" style="text-align:center">
          <button type="button" class="btn" onclick="callReport ();">{% trans "Generate Report" %}</button>
        </td>
      </tr>
    </table>
  </fieldset>
  <table style="width:100%;">
    <tr>
      <th colspan="2" align="center">
        <h2>{% trans "Departments" %} </h2>
      </th>
    </tr>
  </table>
  <div style="width:100%;height:320px;overflow:auto;">
    <table style="width:100%">
      <tr class="department_row">
        <td>
          <input type="checkbox" class="selector all" name="deptid" value="0">
        </td>
        <td><span class="department-name">{% trans "All Departments" %}</span></td>
      </tr>
      {% for department in departments %}
      <tr class="department_row">
        <td valign="top">
          <input type="checkbox" class="selector" name="deptid" value="{{ department.id }}">
        </td>
        <td>
          <div>
            <span class="department-name" style="float:left">{% blocktrans with department.name as deptname %}{{ deptname }}{% endblocktrans %}</span>
            <button class="dept-selector deptid-{{department.id}}"
                    style="width:20px;height:15px;background-color:red;float:right;border:0px;padding-right:10px;display:none;"
                    disabled="disabled">
            </button>
          </div>
        </td>
      </tr>
      {% endfor %}
    </table>
  </div>
</div>
<div id="base_map"></div>
<div id="trending-issues-section">
  <div class="section-title">
    <f> {% trans "Complaint Pendency" %} </f>
  </div>
  <div id="trending-issues-chart"></div>
</div>
<script type="text/javascript" src="/static/jquery/js/jqplot/plugins/jqplot.dateAxisRenderer.js"></script>
<script type="text/javascript" src="/static/jquery/js/jqplot/plugins/jqplot.pointLabels.min.js"></script>
<script type="text/javascript" src="/static/jquery/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="/static/js/CountLabel.js"></script>
<script type="text/javascript" src="/static/js/String.js"></script>
<script type="text/javascript" src="/static/js/Label.js"></script>
<script type="text/javascript" src="/static/js/MapHandler.js"></script>
<script type="text/javascript" src="/static/js/complainthandler.js"></script>
<script type="text/javascript" src="/static/js/department_selector.js"></script>
<script type="text/javascript">
 var states = new Array ();
 var distts = new Array ();
 var blocks = new Array ();
 var gramps = new Array ();
 var villgs = new Array ();

 function add_location_selection (type, code) {
     if (type === 'state') {
         states.push (code);
     } else if (type === 'distt') {
         distts.push (code);
     } else if (type === 'block') {
         blocks.push (code);
     } else if (type === 'gramp') {
         gramps.push (code);
     } else if (type === 'villg') {
         villgs.push (code);
     }
 }

 function update_maps () {
     en_date = $("#id_endate").val ();
     st_date = $("#id_stdate").val ();
     update_issues_maps (MapHandler.departments, MapHandler.map.getZoom (), MapHandler.data_level, st_date, en_date);
 }

 function update_issues_maps (departments, zoomlevel, datalevel, period_start, period_end) {
     show_hot_complaints ("trending-issues-chart", "/complaint/hot_complaints/", departments, period_start, period_end);
     MapHandler.update_with_stats ('/complaint/get_category_map_update/', departments, zoomlevel, datalevel, period_start, period_end);
 }

 function daysBefore (dateObj, ndays) {
     dateObj.setDate (dateObj.getDate () - ndays);
     return dateObj;
 }

 function callReport ()
 {
     var selected_dept_ids = $('.selector:checked').map (
         function () {
             return $(this).val ();
         }
     ).get ().join (',');

     var form = document.createElement ("form");
     form.action = "/complaint/initial_report/";
     form.method = "post";

     var hstdate = document.createElement ("input");
     hstdate.name = "stdate";
     hstdate.type = "text";
     hstdate.value = $("#id_stdate").val ();

     var hendate = document.createElement ("input");
     hendate.name = "endate";
     hendate.type = "text";
     hendate.value = $("#id_endate").val ();

     var deptids = document.createElement ("input");
     deptids.name = "deptids";
     deptids.type = "text";
     deptids.value = selected_dept_ids;

     var stateids = document.createElement ('input');
     stateids.name = 'stateids';
     stateids.type = 'text';
     stateids.value = states.join (",");

     var disttids = document.createElement ('input');
     disttids.name = 'disttids';
     disttids.type = 'text';
     disttids.value = distts.join (",");

     var blockids = document.createElement ('input');
     blockids.name = 'blockids';
     blockids.type = 'text';
     blockids.value = blocks.join (",");

     var grampids = document.createElement ('input');
     grampids.name = 'grampids';
     grampids.type = 'text';
     grampids.value = gramps.join (",");

     var villgids = document.createElement ('input');
     villgids.name = 'villgids';
     villgids.type = 'text';
     villgids.value = villgs.join (",");

     form.appendChild (hstdate);
     form.appendChild (hendate);
     form.appendChild (deptids);
     form.appendChild (stateids);
     form.appendChild (disttids);
     form.appendChild (blockids);
     form.appendChild (grampids);
     form.appendChild (villgids);

     document.body.appendChild (form);

     form.submit ();
 }


 function dateFormat (date) {
     return '%02d/%02d/%04d'.sprintf(date.getDate (),(date.getMonth () + 1),date.getFullYear ());
 }

 $(document).ready (
     function () {
         now = new Date ();
         en_date = dateFormat (now);
         st_date = dateFormat (daysBefore (now, 30));

         $("#id_endate").val (en_date);
         $("#id_stdate").val (st_date);

         $("#id_stdate").datepicker ({dateFormat : 'dd/mm/yy'});
         $("#id_endate").datepicker ({dateFormat : 'dd/mm/yy'});
         department_selector ('/complaint/get_category_map_update/');
         $(".selector").attr ("checked", true);
         MapHandler.init ('base_map', {{ map.center_lat }}, {{ map.center_long }},
                          add_location_selection,
                          function () {
                              update_issues_maps ('0', MapHandler.DISTT_ZOOM, 'distt', st_date, en_date);
                          });
     }
 );
</script>
{% endblock %}
