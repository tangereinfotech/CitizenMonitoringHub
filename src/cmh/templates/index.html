{# Copyright 2011, Tangere Infotech Pvt Ltd [http://tangere.in]                 #}
{#                                                                              #}
{# Licensed under the Apache License, Version 2.0 (the "License");              #}
{# you may not use this file except in compliance with the License.             #}
{# You may obtain a copy of the License at                                      #}
{#                                                                              #}
{#       http://www.apache.org/licenses/LICENSE-2.0                             #}
{#                                                                              #}
{# Unless required by applicable law or agreed to in writing, software          #}
{# distributed under the License is distributed on an "AS IS" BASIS,            #}
{# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.     #}
{# See the License for the specific language governing permissions and          #}
{# limitations under the License.                                               #}

{% extends "signinbase.html" %}
{% block extra_heads %}
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false" ></script>
<meta name="viewport" content="initial-scale=0.1, user-scalable=no" />
{% endblock %}

{% block page_content %}
<div id="department-list">
  <form method="post" action=".">
    <table style="width:100%">
      <tr>
        <th colspan="2" align="center">
          <h2> Departments </h2>
        </th>
      </tr>
      <tr class="department_row">
        <td>
          <input type="checkbox" class="selector all" name="deptid" value="0">
        </td>
        <td><span class="department-name">All Departments</span></td>
      </tr>
      {% for department in departments %}
      <tr class="department_row">
        <td valign="top">
          <input type="checkbox" class="selector" name="deptid" value="{{ department.id }}">
        </td>
        <td> <span class="department-name">{{department.name}}</span> </td>
      </tr>
      {% endfor %}
    </table>
  </form>
</div>
<div id="base_map"></div>
<div id="trending-issues-section">
  <div class="section-title">
    <h2> Trends </h2>
  </div>
  <div class="reportlink">
    <a href="/complaint/report"> Report </a>
  </div>
  <ul class="period-right">
    <li>Last:</li>
    <li><a href="javascript:update_maps (1);">Week</a></li>
    <li><a href="javascript:update_maps (2);">Month</a></li>
    <li><a href="javascript:update_maps (3);">3 Months</a></li>
  </ul>
  <div id="trending-issues-chart"></div>
</div>
<script type="text/javascript" src="/static/jquery/js/jqplot.dateAxisRenderer.js"></script>
<script type="text/javascript" src="/static/jquery/js/jqplot.pointLabels.min.js"></script>
<script type="text/javascript" src="/static/jquery/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="/static/js/CountLabel.js"></script>
<script type="text/javascript" src="/static/js/Label.js"></script>
<script type="text/javascript" src="/static/js/MapHandler.js"></script>
<script type="text/javascript" src="/static/js/complainthandler.js"></script>
<script type="text/javascript" src="/static/js/department_selector.js"></script>
<script type="text/javascript">
    function update_maps (period) {
        switch (period) {
        case 1:
           ndays = 7;
           break;
        case 2:
           ndays = 30;
           break;
        case 3:
           ndays = 90;
           break;
        }
        now = new Date ();
        en_date = dateFormat (now);
        st_date = dateFormat (daysBefore (now, ndays));

        update_issues_maps (MapHandler.departments, MapHandler.map.getZoom (), MapHandler.data_level, st_date, en_date);
    }

    function update_issues_maps (departments, zoomlevel, datalevel, period_start, period_end) {
        MapHandler.update_with_stats ('/complaint/get_category_map_update/', departments, zoomlevel, datalevel, period_start, period_end);
        show_hot_complaints ("trending-issues-chart", "/complaint/hot_complaints/", departments, period_start, period_end);
    }

    function daysBefore (dateObj, ndays) {
        dateObj.setDate (dateObj.getDate () - ndays);
        return dateObj;
    }

    function dateFormat (date) {
        return date.getDate () + "/" + (date.getMonth () + 1) + "/" + date.getFullYear ();
    }

    $(document).ready (function () {
        now = new Date ();
        en_date = dateFormat (now);
        st_date = dateFormat (daysBefore (now, 30));

        department_selector ('/complaint/get_category_map_update/');
        $(".selector").attr ("checked", true);
        MapHandler.init ('base_map', {{ map.center_lat }}, {{ map.center_long }});
        update_issues_maps ('0', MapHandler.VILLG_ZOOM, 'villg', st_date, en_date);
        MapHandler.map.setCenter (MapHandler.bounds.getCenter ());
    });
</script>
{% endblock %}
