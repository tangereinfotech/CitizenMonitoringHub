{# Copyright 2011, Tangere Infotech Pvt Ltd [http://tangere.in]                 #}
{#                                                                              #}
{# Licensed under the Apache License, Version 2.0 (the "License");              #}
{# you may not use this file except in compliance with the License.             #}
{# You may obtain a copy of the License at                                      #}
{#                                                                              #}
{#       http://www.apache.org/licenses/LICENSE-2.0                             #}
{#                                                                              #}
{# Unless required by applicable law or agreed to in writing, software          #}
{# distributed under the License is distributed on an "AS IS" BASIS,            #}
{# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.     #}
{# See the License for the specific language governing permissions and          #}
{# limitations under the License.                                               #}

{% extends "reportbase.html" %}

{% load complaint_extras %}
{% load i18n %}

{% block base_content %}
<div style="clear:both"></div>
<div class="page-header" style="text-align:center;width:100%;">
  {% trans  "Complaint Status Report For Chosen Departments, Locations And Period" %}
</div>
<fieldset>
  <legend>
    {% trans "Selections" %}
  </legend>
  <table width="100%">
    <tr>
      <td style="width:200px">
        <span class="subsection-header" style="font-size:16px;font-weight:bold">{% trans "Report Period" %}</span>
      </td>
      <td colspan="2">
        <b>{{ stats.stdate_show }}</b> {% trans "to" %} <b>{{ stats.endate_show }}</b>
      </td>
    </tr>
    <tr>
      <td>
        <span class="subsection-header" style="font-size:16px;font-weight:bold">{% trans "Selected Departments" %}</span>
      </td>
      <td>
        {% trans "See" %} <a href="#sel_departments">{% trans "Selected Departments" %}</a> {% trans "section for detailed listing" %}
      </td>
    </tr>
    <tr>
      <td>
        <span class="subsection-header" style="font-size:16px;font-weight:bold">{% trans "Selected Locations" %}</span>
      </td>
      <td>
        {% trans "See" %} <a href="#sel_locations">{% trans "Selected Locations" %}</a> {% trans "section for detailed listing" %}
      </td>
    </tr>
  </table>
</fieldset>
<form action="." method="post">
<fieldset>
  <legend>
    {% trans "Report Summary" %}
  </legend>
  <table width="100%">
    <tr>
      <td width="50%">
        <div class="section-header" style="text-align:center;">
          {% trans "Statistics For All Complaints (In Report Period)" %}
        </div>
        <table>
          <tr>
            <td align="right">
              <span style="color:#aecf00">{{ stats.all_complaints.new }}</span>
            </td>
            <td>
              <div style="padding-left:30px">{% trans "New complaints were filed" %}</div>
            </td>
          </tr>
          <tr>
            <td align="right">
              <span style="color:#aecf00">{{ stats.all_complaints.ack }}</span>
            </td>
            <td>
              <div style="padding-left:30px">{% trans "Complaints were acknowledged" %}</div>
            </td>
          </tr>
          <tr>
            <td align="right">
              <span style="color:#aecf00">{{ stats.all_complaints.ope }}</span>
            </td>
            <td>
              <div style="padding-left:30px">{% trans "Complaints were opened for action" %}</div>
            </td>
          </tr>
          <tr>
            <td align="right">
              <span style="color:#aecf00">{{ stats.all_complaints.res }}</span>
            </td>
            <td>
              <div style="padding-left:30px">{% trans "Complaints were resolved" %}</div>
            </td>
          </tr>
          <tr>
            <td align="right">
              <span style="color:#aecf00">{{ stats.all_complaints.clo }}</span>
            </td>
            <td>
              <div style="padding-left:30px">{% trans "Complaints were closed during the period" %}</div>
            </td>
          </tr>
          <tr>
            <td align="right">
              <span style="color:#aecf00">{{ stats.all_complaints.reo }}</span>
            </td>
            <td>
              <div style="padding-left:30px">{% trans "Complaints were reported for further attention" %}</div>
            </td>
          </tr>
          <tr>
            <td align="right">
              <span style="color:#aecf00">{{ stats.all_complaints.pen }}</span>
            </td>
            <td>
              <div style="padding-left:30px">{% trans "Resolved complaints are awaiting complainant feedback" %}</div>
            </td>
          </tr>
        </table>
      </td>
      <td width="50%">
        <div class="section-header" style="text-align:center;">
          {% trans "Statistics For New Complaints (In Report Period)" %}
        </div>
        <table>
          <tr>
            <td>
              <div style="padding-right:15px;font-weight:bold">{% trans "Out of" %}</div>
            </td>
            <td align="right">
              <span style="color:#aecf00">{{ stats.new_complaints.new }}</span>
            </td>
            <td>
              <div style="padding-left:30px">{% trans "complaints were filed in this period" %}</div>
            </td>
          </tr>
          <tr>
            <td/>
            <td align="right">
              <span style="color:#aecf00">{{ stats.new_complaints.ack }}</span>
            </td>
            <td>
              <div style="padding-left:30px">{% trans "Complaints were acknowledged" %}</div>
            </td>
          </tr>
          <tr>
            <td/>
            <td align="right">
              <span style="color:#aecf00">{{ stats.new_complaints.ope }}</span>
            </td>
            <td>
              <div style="padding-left:30px">{% trans "Complaints were opened for action" %}</div>
            </td>
          </tr>
          <tr>
            <td/>
            <td align="right">
              <span style="color:#aecf00">{{ stats.new_complaints.res }}</span>
            </td>
            <td>
              <div style="padding-left:30px">{% trans "Complaints were resolved" %}</div>
            </td>
          </tr>
          <tr>
            <td/>
            <td align="right">
              <span style="color:#aecf00">{{ stats.new_complaints.clo }}</span>
            </td>
            <td>
              <div style="padding-left:30px">{% trans "Complaints were closed during the period" %}</div>
            </td>
          </tr>
          <tr>
            <td/>
            <td align="right">
              <span style="color:#aecf00">{{ stats.new_complaints.reo }}</span>
            </td>
            <td>
              <div style="padding-left:30px">{% trans "Complaints were reported for further attention" %}</div>
            </td>
          </tr>
          <tr>
            <td/>
            <td align="right">
              <span style="color:#aecf00">{{ stats.new_complaints.pen }}</span>
            </td>
            <td>
              <div style="padding-left:30px">{% trans "Resolved complaints are awaiting complainant feedback" %}</div>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</fieldset>
  <div class="section-header width-100 text-center pad-top" style="page-break-before:always">
    {% trans "Complaints Organized By Department (In Report Period)" %}
  </div>
    {% for dept in stats.depts %}
    {% if forloop.counter|divisibleby:"2" %}
    <div style="page-break-after:always;">
    {% endif %}
    <table width="100%"> 
    
    <tr>
      <td colspan="2">
        <div class="text-center pad-top width-100">
          <b><i>{{ dept.name|title }}</i></b>
        </div>
      </td>
    </tr>
    <tr>
      <td width="50%" align="center">
        <div style="width:450px;height:280px" id="volume-{{dept.id}}">
        </div>
      </td>
      <td width="50%" align="center">
        <div style="width:450px;height:280px;" id="time-{{dept.id}}">
        </div>
      </td>
    </tr>
    </table>
    {% if forloop.counter|divisibleby:2 %}
    </div>
    {% endif %}
    {% endfor %}
  <div class="section-header width-100 text-left pad-top" style="page-break-before:always">
    {% trans "Most Filed Complaint Types" %}
  </div>
  <table class="width-100 tabularlist">
    <thead>
      <tr>
        <th>{% trans "Complaint Type" %}</th>
        <th>{% trans "Number of Complaints" %}</th>
        <th>{% trans "Department" %}</th>
        <th>{% trans "Category" %}</th>
      </tr>
    </thead>
    <tbody>
      {% for ct in stats.most_filed %}
      <tr>
        <td> {{ ct.summary }} </td>
        <td> {{ ct.num_complaints }} </td>
        <td> {{ ct.department_name|title }} </td>
        <td> {{ ct.cclass }} </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <div class="section-header width-100 text-left pad-top">
    {% trans "Longest Pending Complaints" %}
  </div>
  <table class="width-100 tabularlist">
    <thead>
      <tr>
        <th>{% trans "Complaint #" %}</th>
        <th>{% trans "Complaint Type" %}</th>
        <th>{% trans "Open Since" %}</th>
        <th>{% trans "Department" %}</th>
        <th>{% trans "Category" %}</th>
      </tr>
    </thead>
    <tbody>
      {% for c in stats.longest_pending %}
      <tr>
        <td> {{ c.complaintno }} </td>
        <td> {{ c.complainttype.summary }} </td>
        <td> {{ c.created|date:"d M, Y" }} </td>
        <td> {{ c.department.name|title }} </td>
        <td> {{ c.complainttype.cclass }} </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <div class="width_100 text-center pad-top section-header" style="page-break-before:always">
    {% trans "Millenium Development Goal Indicators" %}<br/>
    {% trans "(Complaints Filed in Report Period)" %}
  </div>
  <center>
    <div style="width:800px;height:300px;" id="mdgs">
    </div>
    <div style="width:800px;text-align:left;padding-left:162px;">
      <img src="/static/images/MDG-1.jpg" width="65px" class="mdg-report-icons">
      <img src="/static/images/MDG-2.jpg" width="65px" class="mdg-report-icons">
      <img src="/static/images/MDG-3.jpg" width="65px" class="mdg-report-icons">
      <img src="/static/images/MDG-4.jpg" width="65px" class="mdg-report-icons">
      <img src="/static/images/MDG-5.jpg" width="65px" class="mdg-report-icons">
      <img src="/static/images/MDG-6.jpg" width="65px" class="mdg-report-icons">
      <img src="/static/images/MDG-7.jpg" width="65px" class="mdg-report-icons">
    </div>
  </center>
  {% if final %}
  {% if mdgindicators %}
  <div class="width_100 text-left pad-top section-header">
    {% trans "MDG Performance Indicator Notes" %}
  </div>
  <div class="width_100 text_left">{{ mdgindicators }}</div>
  {% endif %}
  {% else %}
  <div class="width_100 text-left pad-top section-header">
    {% trans "MDG Performance Indicator Notes" %}
  </div>
  <textarea cols="130" rows="6" name="mdgindicators"></textarea>
  {% endif %}
  {% if final %}
  {% if suggestions %}
  <div class="width_100 text-left pad-top section-header">
    {% trans "Suggested Follow-up Actions" %}
  </div>
  <div style="width:850px;height:75px">{{ suggestions }}</div>
  {% endif %}
  {% else %}
  <div class="width_100 text-left pad-top section-header">
    {% trans "Suggested Follow-up Actions" %}
  </div>
  <textarea cols="130" rows="6" name="suggestions"></textarea>
  {% endif %}
  {% if not final %}
  <div class="width_100 text-center pad-top" style="page-break-after:always;">
    <input type="hidden" name="stdate" value="{{ stats.stdate }}"/>
    <input type="hidden" name="endate" value="{{ stats.endate }}"/>
    <input type="hidden" name="deptids" value="{{ stats.deptids }}"/>
    <input type="hidden" name="stateids" value="{{ stats.stateids }}"/>
    <input type="hidden" name="disttids" value="{{ stats.disttids }}"/>
    <input type="hidden" name="blockids" value="{{ stats.blockids }}"/>
    <input type="hidden" name="grampids" value="{{ stats.grampids }}"/>
    <input type="hidden" name="villgids" value="{{ stats.villgids }}"/>
    <input type="submit" style="font-size:24px;font-weight:bold;width:290px;height:50px" name="final" class="btn" value="PRINT FINAL REPORT"/>
  </div>
  {% endif %}
<fieldset>
  <legend>
    {% trans "Selected Departments" %}
  </legend>
  <table class="tabularlist width-100">
    <thead>
      <tr>
        <th>
          <div class="subsection-header"><a name="sel_departments">{% trans "Department Names" %}</a></div>
        </th>
      </tr>
    </thead>
    <tbody>
      {% for dept in stats.depts %}
      <tr>
        <td>
          <div style="text-align:left;width:100%">
            {{ dept.name|title }}
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</fieldset>
<fieldset>
  <legend>
    {% trans "Selected Locations" %}
  </legend>
  <table class='tabularlist'>
    <thead>
      <tr>
        <th><a name="sel_locations">{% trans "Block" %}</a></th>
        <th>{% trans "Gram Panchayat" %}</th>
        <th>{% trans "Village" %}</th>
      </tr>
    </thead>
    <tbody>
      {% for block in stats.blocks %}
      <tr>
        <td colspan="3">
          <div style="text-align:left;">
            {{ block.name|title }}
          </div>
        </td>
      </tr>
      {% endfor %}
      {% for gramp in stats.gramps %}
      <tr>
        <td>
          <div style="text-align:left;">
            {{ gramp.block.name|title }}
          </div>
        </td>
        <td colspan="2" align="left">
          <div style="text-align:left;">
            {{ gramp.name|title }}
          </div>
        </td>
      </tr>
      {% endfor %}
      {% for villg in stats.villgs %}
      <tr>
        <td align="left">
          <div style="text-align:left;">
            {{ villg.grampanchayat.block.name|title }}
          </div>
        </td>
        <td align="left">
          <div style="text-align:left;">
            {{ villg.grampanchayat.name|title }}
          </div>
        </td>
        <td align="left">
          <div style="text-align:left;">
            {{ villg.name|title }}
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</fieldset>
</form>
{% endblock %}

{% block body_scripts %}
 <script type="text/javascript" src="/static/jquery/js/jqplot/plugins/jqplot.canvasTextRenderer.min.js"></script>
 <script type="text/javascript" src="/static/jquery/js/jqplot/plugins/jqplot.canvasAxisTickRenderer.js"></script>
 <script type="text/javascript" src="/static/jquery/js/jqplot/plugins/jqplot.categoryAxisRenderer.min.js"></script>
 <script type="text/javascript" src="/static/jquery/js/jqplot/plugins/jqplot.enhancedLegendRenderer.js"></script>
 <script type="text/javascript" src="/static/jquery/js/jqplot/plugins/jqplot.pointLabels.min.js"></script>
 <script type="text/javascript" src="/static/jquery/js/jqplot/plugins/jqplot.barRenderer.min.js"></script>
 <script type="text/javascript" src="/static/jquery/js/jqplot/plugins/jqplot.dateAxisRenderer.js"></script>
 <script type="text/javascript" src="/static/jquery/js/jqplot/plugins/jqplot.canvasAxisLabelRenderer.min.js"></script>
 <script type="text/javascript">
 $(document).ready(
     function () {
         $.jqplot.config.enablePlugins = true;
         {% for dept in stats.depts %}
         $.jqplot('volume-{{dept.id}}', {{ stats.volume|get_schemes_data:dept.id }},
                  {
                      seriesColors : ["#948b54", "#95b3d7"],
                      seriesDefaults:{
                          renderer:$.jqplot.BarRenderer,
                          rendererOptions : {
                              barWidth : 25
                          }
                      },
                      legend: {
                          show: true,
                          labels:['Acknowledged','Closed']
                          }, 
                      axes: {
                          xaxis: {
                              renderer: $.jqplot.CategoryAxisRenderer,
                              ticks: [{% for s in stats.volume|get_schemes:dept.id %} "{{ s|safe }}" {% if not forloop.last %} , {% endif %} {% endfor %}],
                              tickOptions : {
                                  angle:-30,
                                  labelPosition : 'middle'
                              },
                              tickRenderer : $.jqplot.CanvasAxisTickRenderer
                          },
                          yaxis: {
                              min : 0,
                              pad: 1.5,
                              tickOptions: {
                                  show: false,
                                  formatString:'%d',
                              },
                              label : '{% trans "Number of Complaints" %}',
                              labelRenderer: $.jqplot.CanvasAxisLabelRenderer,
                          }
                      }
                  });
         $.jqplot('time-{{dept.id}}', {{ stats.time|get_schemes_data:dept.id }},
                  {
                      seriesColors : ["#c5be97", "#538ed5"],
                      seriesDefaults:{
                          renderer:$.jqplot.BarRenderer,
                          rendererOptions : {
                              barWidth : 25
                          }
                      },
                      legend: {
                          show: true,
                          labels:['Max Response Time','Average Response Time']
                          }, 
                      axes: {
                          xaxis: {
                              renderer: $.jqplot.CategoryAxisRenderer,
                              ticks: [{% for s in stats.time|get_schemes:dept.id %} "{{ s|safe }}" {% if not forloop.last %} , {% endif %} {% endfor %}],
                              tickOptions : {angle:-30, labelPosition : 'middle'},
                              tickRenderer : $.jqplot.CanvasAxisTickRenderer
                          },
                          yaxis: {
                              min : 0,
                              pad: 1.5,
                              tickOptions: {
                                  show: false,
                                  formatString:'%d',
                              },
                              label : '{% trans "Days" %}',
                              labelRenderer: $.jqplot.CanvasAxisLabelRenderer,
                          }
                      }
                  });
         {% endfor %}
         $.jqplot('mdgs', {{ stats.mdgs }},
                  {
                      seriesColors : ["#fcdb00", "#bbd802", "#abaac9", "#b2def7", "#b2def7", "#b2def7", "#5ba129"],
                      seriesDefaults:{
                          renderer:$.jqplot.BarRenderer,
                          rendererOptions : {
                              barWidth : 65,
                              barPadding: 35
                          }
                      },
                      axes: {
                          xaxis: {
                              renderer: $.jqplot.CategoryAxisRenderer,
                              ticks: [' ']
                          },
                          yaxis: {
                              min : 0,
                              pad: 1.5,
                              tickOptions: {
                                  show: false,
                                  formatString:'%d',
                              },
                              label : '{% trans "Number of Complaints" %}',
                              labelRenderer: $.jqplot.CanvasAxisLabelRenderer,
                          }
                      }
                  });
         $(".edit_selection").click (
             function (event) {
                 var form = document.createElement ("form");

                 form.action = "/complaint/edit_report/";
                 form.method = "post";

                 var stdate = document.createElement ("input");
                 stdate.name = "stdate";
                 stdate.type = "hidden";
                 stdate.value = "{{ stats.stdate }}";

                 var endate = document.createElement ("input");
                 endate.name = "endate";
                 endate.type = "hidden";
                 endate.value = "{{ stats.endate }}";

                 var deptids = document.createElement ("input");
                 deptids.name = "deptids";
                 deptids.type = "hidden";
                 deptids.value = "{{ stats.deptids }}";

                 var stateids = document.createElement ("input");
                 stateids.name = "stateids";
                 stateids.type = "hidden";
                 stateids.value = "{{ stats.stateids }}";

                 var disttids = document.createElement ("input");
                 disttids.name = "disttids";
                 disttids.type = "hidden";
                 disttids.value = "{{ stats.disttids }}";

                 var blockids = document.createElement ("input");
                 blockids.name = "blockids";
                 blockids.type = "hidden";
                 blockids.value = "{{ stats.blockids }}";

                 var grampids = document.createElement ("input");
                 grampids.name = "grampids";
                 grampids.type = "hidden";
                 grampids.value = "{{ stats.grampids }}";

                 var villgids = document.createElement ("input");
                 villgids.name = "villgids";
                 villgids.type = "hidden";
                 villgids.value = "{{ stats.villgids }}";

                 form.appendChild (stdate);
                 form.appendChild (endate);
                 form.appendChild (deptids);
                 form.appendChild (stateids);
                 form.appendChild (disttids);
                 form.appendChild (blockids);
                 form.appendChild (grampids);
                 form.appendChild (villgids);

                 document.body.appendChild (form);
                 form.submit ();
             });
     });
</script>
{% endblock %}
